@model AttributeViewModel

@{
  Layout = "~/Areas/Editor/Views/Editor/Components/_Layout.cshtml";
}

<script type="text/javascript">
  var @($"{Model.AttributeDescriptor.Key}Tree");

  Ext.onReady(function(){
    var Tree            = Ext.tree;

  //track what nodes are moved
    var oldPosition     = null;
    var oldNextSibling  = null;
    var debugMessage    = "";

    @($"{Model.AttributeDescriptor.Key}Tree") = new Tree.TreePanel({
      useArrows                 : true,
      autoScroll                : true,
      animate                   : false,
      enableDD                  : true,
      containerScroll           : true,
      border                    : false,
      baseCls                   : 'TreeView',
      dataUrl                   : '/OnTopic/Json/@Model.WebPath/@Model.AttributeDescriptor.Key?ShowAll=true',
      root                      : new Ext.tree.AsyncTreeNode({}),
      rootVisible               : false,
    });

    @if (!Model.IsNew) {
      <text>
        @($"{Model.AttributeDescriptor.Key}Tree").render('@ViewData.TemplateInfo.GetFullHtmlFieldName("Container")');
      </text>
    }
  });

  </script>

<div id="@ViewData.TemplateInfo.GetFullHtmlFieldName("Container")"></div>

@if (!Model.IsNew) {
  var options                   = new TopicLookupOptions() {
    Scope                       = "Configuration:ContentTypes",
    AttributeName               = "ContentType",
    AttributeValue              = "ContentType",
    AllowedKeys                 = Model.Options.ContentTypes,
    Label                       = "Add child topic…",
    TargetUrl                   = $"?ContentType{{Topic}}&Path={Model.UniqueKey}:{Model.AttributeDescriptor.Key}&Action=Add",
    TargetPopup                 = Model.Options.TargetPopup,
    OnClientClose               = $"{Model.AttributeDescriptor.Key}Tree_refresh"
  };
  <text>
    <vc:topic-lookup
      attribute=@Model.AttributeDescriptor
      html-field-prefix=@ViewData.TemplateInfo.HtmlFieldPrefix
      options=@options>
    </vc:topic-lookup>
  </text>
}
else {
  <div class="alert alert-warning">
    Subtopics cannot be created until this topic has been saved. Save the topic, then add nested topics.
  </div>
}
