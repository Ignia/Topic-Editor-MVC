@model Ignia.Topics.Editor.Models.EditorViewModel

@{
  ViewBag.Title = "Home Page";
  var bindingModel = new EditorBindingModel();
}

<form asp-controller="Editor" asp-action="Edit" method="post" id="EditorForm">

  <partial name="_Toolbar" />

  <div id="FormArea" class="row form area">
    <div class="col-md-9">
      @{int index = 0;}
      <div id="DisplayGroupTabsContent" class="tab-content">
        @foreach (string category in Model.ContentTypeDescriptor.AttributeDescriptors.Select(a => a.DisplayGroup).Distinct().OrderBy(a => a)) {

          var supportedAttributes = Model.ContentTypeDescriptor.AttributeDescriptors.Where(a => a.DisplayGroup.Equals(category));
          var displayGroup = category.Replace(" ", "");

          <div id="Group_@displayGroup" class="tab-pane fade@(index == 0 ? " show active" : "")" role="tabpanel" aria-labelledby="Tab_@displayGroup">
            <section id="@category.Replace(" ", "-")">

              @foreach (var attribute in supportedAttributes.OrderBy(a => a.SortOrder)) {

                if (attribute.IsHidden || String.IsNullOrEmpty(attribute.EditorType)) {
                  continue;
                }

                @await Component.InvokeAsync(
                  attribute.EditorType.Replace(".ascx", ""),
                  new { Attribute=attribute, HtmlFieldPrefix=$"Attributes[{index++}]" }
                )

              }

            </section>
          </div>

        }
      </div>

    </div>
    <div class="col-md-3 callouts">
      <div class="callout topic-info">

        <h3 class="h5">Topic Information</h3>
        <dl>
          <dt><i class="fa fa-cogs"></i> Content Type</dt>
          <dd><a href="/Configuration/ContentTypes/@Model.Topic.ContentType">@Model.Topic.ContentType</a></dd>
          <dt><i class="fa fa-database"></i> Topic ID</dt>
          <dd><a href="/Topic/@Model.Topic.Id/">@Model.Topic.Id</a></dd>
          <dt><i class="fa fa-eye"></i> Current</dt>
          <dd><a href="@Model.Topic.WebPath">View Page</a></dd>
        </dl>

      </div>
    </div>
  </div>

</form>

@section scripts {
  <script>

    $(function() {

      /**
       * Sends AJAX request to Save/Edit Action
       */
      $('#SavePageButton').click(function() {

        $.ajax({
          url                   : '@Url.Action("Edit", "Editor", new { path = Model.Topic.WebPath })',
          type                  : 'POST',
          data                  : @bindingModel,
          success: function (result) {
            if (result == true) {
            }
            else {
            }
          }
        });

      });

      /**
       * Sends AJAX request to Delete Action
       */
      $('#DeletePageButton').on('click', function(e) {
        e.preventDefault();
        var $this = $(this);
        if (confirm('Are you sure you want to delete the "@(Model.Topic.Title?.Replace("'", "&rsquo;")?? Model.Topic.Key)" topic? The topic and all descendants will be permanently deleted.')) {
          window.location.href = "@Url.Action("Delete", "Editor", new { path = Model.Topic.WebPath })";
        }
      });

    });

  </script>
}
